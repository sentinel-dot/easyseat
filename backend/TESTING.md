# üß™ Easyseat Backend Testing Guide

Umfassende Test-Suite f√ºr das Easyseat Backend mit Jest und Postman.

## üìã Inhaltsverzeichnis

1. [Setup](#setup)
2. [Automatisierte Tests (Jest)](#automatisierte-tests-jest)
3. [Manuelle Tests (Postman)](#manuelle-tests-postman)
4. [Test-Szenarien](#test-szenarien)
5. [Troubleshooting](#troubleshooting)

---

## üîß Setup

### 1. Abh√§ngigkeiten installieren

```bash
cd backend
npm install
```

### 2. Test-Datenbank vorbereiten

Stelle sicher, dass deine Datenbank mit dem Seed-Script bef√ºllt ist:

```bash
# MariaDB Shell √∂ffnen
sudo mariadb

# Seed ausf√ºhren
USE easyseatdb;
SOURCE src/config/database/seed.sql;
```

### 3. Environment-Variablen

Die `.env.test` Datei ist bereits konfiguriert. Falls n√∂tig, passe die Werte an:

```env
NODE_ENV=test
PORT=3000
DB_USER=dev
DB_PASSWORD=devpw
DB_NAME=easyseatdb
```

---

## ü§ñ Automatisierte Tests (Jest)

### Alle Tests ausf√ºhren

```bash
npm test
```

### Tests im Watch-Modus

```bash
npm run test:watch
```

### Coverage Report generieren

```bash
npm run test:coverage
```

### Nur Venue Tests

```bash
npm run test:venues
```

### Nur Availability Tests

```bash
npm run test:availability
```

### Verbose Output

```bash
npm run test:verbose
```

---

## üìÆ Manuelle Tests (Postman)

### Postman Collection importieren

1. **Postman √∂ffnen**
2. **Import** ‚Üí **File** ‚Üí W√§hle `Easyseat API Tests.postman_collection.json`
3. **Import** ‚Üí **File** ‚Üí W√§hle `Easyseat.postman_environment.json`
4. **Environment** auf "Easyseat Local" setzen

### Collection ausf√ºhren

#### Manuelle Ausf√ºhrung
- Klicke auf "Easyseat API Tests"
- W√§hle einen Ordner (z.B. "Venues")
- Klicke auf einzelne Requests zum Testen

#### Collection Runner
1. Rechtsklick auf "Easyseat API Tests"
2. **Run collection**
3. W√§hle Environment: "Easyseat Local"
4. **Run**

#### Mit Newman (CLI)

```bash
# Newman installieren (global)
npm install -g newman

# Collection ausf√ºhren
newman run "Easyseat API Tests.postman_collection.json" \
  -e Easyseat.postman_environment.json \
  --reporters cli,json

# Mit HTML Report
newman run "Easyseat API Tests.postman_collection.json" \
  -e Easyseat.postman_environment.json \
  --reporters cli,htmlextra \
  --reporter-htmlextra-export ./test-results/report.html
```

---

## üéØ Test-Szenarien

### 1. Venue Tests

#### ‚úÖ Success Cases
- `GET /venues` - Alle aktiven Venues
- `GET /venues/1` - Bella Vista Restaurant Details
- `GET /venues/2` - Salon Schmidt Details

#### ‚ùå Error Cases
- `GET /venues/invalid` - 400: Invalid ID (String)
- `GET /venues/0` - 400: Invalid ID (Zero)
- `GET /venues/-1` - 400: Invalid ID (Negative)
- `GET /venues/9999` - 404: Venue not found

#### üîç Was wird getestet?
- Korrekte Response-Struktur
- Alle ben√∂tigten Felder vorhanden
- Restaurant hat **keine** Staff Members
- Hair Salon hat Staff Members
- Services mit korrektem `requires_staff` Flag

---

### 2. Availability Slots Tests

#### ‚úÖ Success Cases
- `GET /availability/slots` - Restaurant Tische f√ºr morgen
- `GET /availability/slots` - Hair Salon mit Staff f√ºr n√§chsten Dienstag

#### ‚ùå Error Cases
- Fehlende `venueId` - 400
- Fehlende `serviceId` - 400
- Fehlende `date` - 400

#### üîç Was wird getestet?
- Time Slots haben korrekte Struktur
- `start_time` und `end_time` vorhanden
- `available` ist Boolean
- Staff-Services haben `staff_member_id`
- Slot-Dauer entspricht Service-Duration
- Montag-Vormittag: Restaurant geschlossen (keine Slots)

---

### 3. Week Availability Tests

#### ‚úÖ Success Cases
- `GET /availability/week` - 7 Tage f√ºr Restaurant
- `GET /availability/week` - 7 Tage f√ºr Hair Salon

#### ‚ùå Error Cases
- Fehlende Parameter - 400

#### üîç Was wird getestet?
- Genau 7 Tage zur√ºckgegeben
- Jeder Tag hat `date`, `day_of_week`, `time_slots`
- Slots korrekt √ºber Woche verteilt

---

### 4. Availability Check Tests

#### ‚úÖ Success Cases
- `POST /availability/check` - Valider Restaurant-Slot
- `POST /availability/check` - Valider Hair-Salon-Slot mit Staff

#### ‚ùå Error Cases
- Au√üerhalb √ñffnungszeiten - Available: false
- Kapazit√§t √ºberschritten - Available: false, Reason: capacity
- Fehlende Felder - 400

#### üîç Was wird getestet?
- `available` Boolean vorhanden
- `reason` bei nicht-verf√ºgbaren Slots
- √ñffnungszeiten werden respektiert
- Kapazit√§ts-Limits funktionieren
- Past Dates werden abgelehnt

---

### 5. Validation Tests

#### ‚úÖ Success Cases
- `POST /availability/validate` - Valide Restaurant-Buchung
- `POST /availability/validate` - Valide Hair-Salon-Buchung mit Staff

#### ‚ùå Error Cases
- Ung√ºltiges Zeitformat (25:00) - 400, Fehler-Array
- End vor Start - 400, "after start time"
- Staff fehlt bei required Service - 400, "Staff member is required"
- Past Date - 400, "Cannot book in the past"

#### üîç Was wird getestet?
- `valid` Boolean
- `errors` Array leer bei Success
- Fehler-Nachrichten spezifisch und hilfreich
- Zeitformat-Validierung (HH:MM)
- Zeitlogik (End > Start)
- Staff-Requirement f√ºr Services

---

### 6. Service Details Tests

#### ‚úÖ Success Cases
- `GET /availability/service/1?venueId=1` - Tisch f√ºr 2 Personen
- `GET /availability/service/4?venueId=2` - Herrenhaarschnitt

#### ‚ùå Error Cases
- Fehlende `venueId` - 400
- Service nicht gefunden - 404

#### üîç Was wird getestet?
- Service-ID, Name, Description
- `duration_minutes`, `price`, `capacity`
- `requires_staff` Flag korrekt
- Restaurant: requires_staff = false
- Hair Salon: requires_staff = true

---

### 7. Staff Capability Tests

#### ‚úÖ Success Cases
- `GET /staff/1/can-perform/4` - Anna kann Herrenhaarschnitt (true)
- `GET /staff/1/can-perform/5` - Anna kann Damenhaarschnitt (true)
- `GET /staff/1/can-perform/6` - Anna kann Coloration (true)
- `GET /staff/2/can-perform/4` - Klaus kann Herrenhaarschnitt (true)

#### ‚ùå Negative Cases (Expected false)
- `GET /staff/2/can-perform/5` - Klaus kann NICHT Damenhaarschnitt (false)
- `GET /staff/2/can-perform/6` - Klaus kann NICHT Coloration (false)
- `GET /staff/999/can-perform/4` - Ung√ºltiger Staff (false)
- `GET /staff/2/can-perform/999` - Ung√ºltiger Service (false)

#### üîç Was wird getestet?
- Anna (ID 1) kann **alle 3 Services** (4, 5, 6)
- Klaus (ID 2) kann **nur Service 4** (Herrenhaarschnitt)
- Ung√ºltige IDs geben `canPerform: false` zur√ºck
- Keine 404-Fehler, sondern immer 200 mit Boolean

---

## üìä Test Coverage

### Erwartete Coverage

Nach Ausf√ºhrung von `npm run test:coverage`:

```
--------------------|---------|----------|---------|---------|
File                | % Stmts | % Branch | % Funcs | % Lines |
--------------------|---------|----------|---------|---------|
venue.routes.ts     |   100   |   100    |   100   |   100   |
venue.service.ts    |   95+   |   90+    |   100   |   95+   |
availability.routes |   100   |   100    |   100   |   100   |
availability.service|   90+   |   85+    |   95+   |   90+   |
--------------------|---------|----------|---------|---------|
```

### Coverage Report ansehen

```bash
npm run test:coverage
# √ñffne: coverage/lcov-report/index.html
```

---

## üóÇÔ∏è Test-Daten (aus seed.sql)

### Venues

| ID | Name | Type | √ñffnungszeiten |
|----|------|------|----------------|
| 1 | Bella Vista Restaurant | restaurant | Mo: 17:00-22:00<br>Di-So: 11:30-22:00 |
| 2 | Salon Schmidt | hair_salon | Di-Sa: 09:00-18:00 |

### Services (Restaurant - Venue 1)

| ID | Name | Duration | Capacity | Requires Staff |
|----|------|----------|----------|----------------|
| 1 | Tisch f√ºr 2 Personen | 120 Min | 2 | ‚ùå false |
| 2 | Tisch f√ºr 4 Personen | 120 Min | 4 | ‚ùå false |
| 3 | Gro√üer Tisch (6-8) | 150 Min | 8 | ‚ùå false |

### Services (Hair Salon - Venue 2)

| ID | Name | Duration | Price | Requires Staff |
|----|------|----------|-------|----------------|
| 4 | Herrenhaarschnitt | 45 Min | ‚Ç¨35 | ‚úÖ true |
| 5 | Damenhaarschnitt | 90 Min | ‚Ç¨55 | ‚úÖ true |
| 6 | Coloration | 180 Min | ‚Ç¨95 | ‚úÖ true |

### Staff Members (Salon Schmidt)

| ID | Name | Services |
|----|------|----------|
| 1 | Anna Schmidt | 4, 5, 6 (alle) |
| 2 | Klaus Meyer | 4 (nur Herrenhaarschnitt) |

### Bestehende Bookings (aus seed.sql)

| Venue | Service | Date | Time | Party Size | Status |
|-------|---------|------|------|------------|--------|
| 1 | Tisch f√ºr 4 | Morgen | 19:00-21:00 | 4 | confirmed |
| 2 | Herrenhaarschnitt (Klaus) | Morgen | 10:00-10:45 | 1 | pending |

---

## üêõ Troubleshooting

### Problem: Tests schlagen fehl mit "Connection refused"

**L√∂sung:**
```bash
# Pr√ºfe, ob Server l√§uft
curl http://localhost:3000/health

# Falls nicht, starte den Server
npm run dev
```

### Problem: Boolean-Werte sind 0/1 statt true/false

**Erkl√§rung:** MariaDB/MySQL gibt BOOLEAN-Felder als `0` und `1` zur√ºck, nicht als `true`/`false`.

**L√∂sung:** Die Tests verwenden `.toBeTruthy()` und `.toBeFalsy()` statt `.toBe(true)` bzw `.toBe(false)`.

```typescript
// ‚ùå Falsch
expect(service.requires_staff).toBe(false); // Schl√§gt fehl wenn 0

// ‚úÖ Richtig
expect(service.requires_staff).toBeFalsy(); // Akzeptiert 0 oder false
```

### Problem: DECIMAL-Werte sind Strings statt Numbers

**Erkl√§rung:** MariaDB/MySQL gibt DECIMAL-Felder als Strings zur√ºck (z.B. `"35.00"` statt `35`).

**L√∂sung:** Parse mit `parseFloat()` vor dem Vergleich.

```typescript
// ‚ùå Falsch
expect(service.price).toBe(35); // Schl√§gt fehl wenn "35.00"

// ‚úÖ Richtig
expect(parseFloat(service.price)).toBe(35); // Konvertiert erst zu Number
```

### Problem: "Service not found" bei g√ºltiger ID

**L√∂sung:**
```bash
# Pr√ºfe Datenbank
sudo mariadb easyseatdb

# Zeige alle Services
SELECT id, name, venue_id, is_active FROM services;

# Re-seed falls n√∂tig
SOURCE src/config/database/seed.sql;
```

### Problem: Jest findet Tests nicht

**L√∂sung:**
```bash
# Pr√ºfe Dateistruktur
ls -la src/__tests__/

# Tests sollten im Ordner sein:
# - src/__tests__/setup.ts
# - src/__tests__/venue.routes.test.ts
# - src/__tests__/availability.routes.test.ts
```

### Problem: "tomorrow" Variable ist leer in Postman

**L√∂sung:**
- Die Variable wird im **Pre-request Script** gesetzt
- Stelle sicher, dass Pre-request Scripts aktiviert sind
- Alternativ: Manuell setzen in Environment:
  ```
  tomorrow: 2025-10-19 (YYYY-MM-DD)
  ```

### Problem: Newman gibt HTML-Fehler zur√ºck

**L√∂sung:**
```bash
# Newman Reporter installieren
npm install -g newman-reporter-htmlextra

# Test erneut ausf√ºhren
newman run "Easyseat API Tests.postman_collection.json" \
  -e Easyseat.postman_environment.json \
  --reporters cli,htmlextra
```

### Problem: Tests sind langsam

**L√∂sung:**
```bash
# Nur ge√§nderte Tests ausf√ºhren
npm run test:watch

# Parallel ausf√ºhren (vorsichtig mit DB-Connections!)
jest --maxWorkers=4

# Einzelne Test-Suite
npm run test:venues
```

---

## üìù Test-Checkliste f√ºr neue Features

Wenn du neue Features hinzuf√ºgst, stelle sicher:

- [ ] **Unit Tests** f√ºr alle neuen Service-Methoden
- [ ] **Route Tests** f√ºr alle neuen Endpoints
- [ ] **Success Cases** getestet
- [ ] **Error Cases** getestet (400, 404, 500)
- [ ] **Validation** getestet (ung√ºltige Inputs)
- [ ] **Edge Cases** getestet (Grenzwerte, leere Arrays, null)
- [ ] **Postman Collection** aktualisiert
- [ ] **Documentation** aktualisiert (API Docs)
- [ ] **Coverage** √ºber 80% f√ºr neue Dateien

---

## üé® Best Practices

### 1. Test-Naming Convention

```typescript
describe('Service/Route Name', () => {
  describe('Method/Endpoint', () => {
    it('should [expected behavior]', async () => {
      // Test
    });
  });
});
```

**Beispiel:**
```typescript
describe('Venue Routes', () => {
  describe('GET /venues/:id', () => {
    it('should return venue details for valid ID', async () => {
      // ...
    });
  });
});
```

### 2. Arrange-Act-Assert Pattern

```typescript
it('should validate booking request', async () => {
  // Arrange
  const bookingData = { venueId: 1, serviceId: 1, ... };
  
  // Act
  const response = await request(app)
    .post('/availability/validate')
    .send(bookingData);
  
  // Assert
  expect(response.status).toBe(200);
  expect(response.body.data.valid).toBe(true);
});
```

### 3. Verwende Helper-Funktionen

```typescript
// Helper f√ºr Datum-Generierung
const getTomorrowDate = (): string => {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  return tomorrow.toISOString().split('T')[0];
};

// Im Test verwenden
it('should accept future dates', async () => {
  const date = getTomorrowDate();
  // ...
});
```

### 4. Cleanup nach Tests

```typescript
afterEach(async () => {
  // Bereinige Test-Daten
  // z.B. L√∂sche Test-Bookings
});

afterAll(async () => {
  // Schlie√üe DB-Connections
  await pool.end();
});
```

---

## üìö Weitere Ressourcen

- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [Supertest GitHub](https://github.com/ladjs/supertest)
- [Postman Learning Center](https://learning.postman.com/)
- [Newman Documentation](https://learning.postman.com/docs/running-collections/using-newman-cli/)

---

## ‚úÖ Quick Test Commands

```bash
# Alles testen
npm test

# Nur ein Test-File
npm test venue.routes.test.ts

# Mit Coverage
npm run test:coverage

# Watch Mode (w√§hrend Entwicklung)
npm run test:watch

# Postman via Newman
newman run "Easyseat API Tests.postman_collection.json" -e Easyseat.postman_environment.json
```

---

## üöÄ CI/CD Integration

### GitHub Actions Beispiel

```yaml
name: Backend Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mariadb:
        image: mariadb:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: easyseatdb
          MYSQL_USER: dev
          MYSQL_PASSWORD: devpw
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd backend
          npm install
      
      - name: Run tests
        run: |
          cd backend
          npm test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
```

---

## üí° Pro-Tipps

1. **Teste immer Edge Cases**: 0, -1, null, undefined, sehr gro√üe Zahlen
2. **Teste asynchrone Operationen**: Verwende async/await korrekt
3. **Isoliere Tests**: Jeder Test sollte unabh√§ngig laufen
4. **Verwende Mocks sparsam**: Teste gegen echte DB (mit seed)
5. **Coverage ist kein Ziel**: 100% Coverage ‚â† Bug-frei
6. **Schreibe lesbare Tests**: Tests sind Dokumentation
7. **Teste das Verhalten, nicht die Implementierung**

---

**Happy Testing! üéâ**